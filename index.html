<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sobre Especial</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Importar fuente Pacifico de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <!-- Iconos para el bot√≥n de m√∫sica -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        /* Mejoras para m√≥vil */
        html, body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            touch-action: manipulation;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #1c258b; /* Azul profundo que contrasta bien con el rojo */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }
        
        #wrapper {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
            text-align: center;
        }
        
        /* Bot√≥n de m√∫sica */
        .music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 82, 82, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border: 2px solid white;
        }
        
        .music-control:hover {
            background: rgba(255, 82, 82, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .music-control i {
            font-size: 24px;
            color: white;
        }
        
        .music-control.playing i {
            color: #ffeb3b;
        }
        
        .music-control.pulsing {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }
        
        /* Notificaci√≥n de m√∫sica */
        .music-notification {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 200px;
            z-index: 999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            text-align: center;
        }
        
        .music-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* EL SOBRE (CONTENEDOR) - Color rojo elegante */
        .envelope {
            width: 200px;
            height: 100px;
            margin: 0 auto;
            background: linear-gradient(145deg, #b92424, #ff5252);
            box-shadow: 
                0 0 1px rgba(0,0,0,0.3),
                0 4px 20px rgba(0,0,0,0.25),
                0 15px 40px rgba(255, 82, 82, 0.3),
                0 0 80px rgba(255, 82, 82, 0.15);
            position: relative;
            perspective: 800px;
            cursor: pointer;
            border-radius: 2px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .envelope:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 0 1px rgba(0,0,0,0.3),
                0 6px 25px rgba(0,0,0,0.3),
                0 20px 50px rgba(255, 82, 82, 0.35),
                0 0 100px rgba(255, 82, 82, 0.2);
        }
        
        .envelope:active {
            transform: translateY(0);
        }
        
        .envelope:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            border: 0 solid rgba(0,0,0,0.15);
            border-width: 45px 100px;
            border-top-color: transparent;
            z-index: 2;
        }
        
        .envelope .flap {
            position: absolute;
            width: 100%;
            height: 0;
            border: 0 solid transparent;
            border-width: 50px 100px;
        }
        
        .envelope .flap.front {
            border-left-color: #e26060;
            border-right-color: #e26060;
            border-bottom-color: #e74c3c;
            z-index: 3;
        }
        
        .envelope .flap.front:after {
            content: '';
            width: 100%;
            height: 0;
            position: absolute;
            left: -100px;
            bottom: -50px;
            border: 0 solid transparent;
            border-width: 49px 100px;
            border-bottom-color: #e26060;
        }
        
        .envelope .flap.top {
            border-top-width: 55px;
            border-top-color: #e74c3c;
            z-index: 3;
            animation-duration: 1s;
            animation-fill-mode: forwards;
            transform-origin: top;
            transform-style: preserve-3d;
        }
        
        .envelope.open .flap.top {
            animation-name: flip;
        }
        
        .envelope.closing-step4 .flap.top {
            animation-name: flip-reverse;
            animation-delay: 0s;
        }
        
        .envelope .flap.top:after {
            content: '';
            position: absolute;
            left: -100px;
            top: -55px;
            width: 100%;
            height: 0;
            border: 0 solid transparent;
            border-width: 54px 100px;
            border-top-color: #d33b3b;
        }
        
        .envelope.letter-open .flap.top {
            transform: rotateX(180deg);
            z-index: 1 !important; 
        }
        
        .envelope.closing-step1 .flap.top,
        .envelope.closing-step2 .flap.top,
        .envelope.closing-step3 .flap.top {
            transform: rotateX(180deg);
            z-index: 1 !important;
        }
        
        /* LA CARTA */
        .envelope .letter {
            position: absolute;
            width: 194px;
            height: 84px;
            background: linear-gradient(to bottom, #fff9f9, #fff);
            top: 8px;
            left: 3px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            z-index: 1;
            animation-duration: 2s;
            animation-delay: 1.5s;
            animation-fill-mode: forwards;
            transform-style: preserve-3d;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 10px rgba(255, 107, 107, 0.1);
            border-radius: 1px;
        }

        /* --- ESTILOS DEL TEXTO CON FUENTE PACIFICO --- */
        .letter-content {
            font-family: 'Pacifico', cursive; /* Fuente Pacifico moderna y redondeada */
            font-size: 15px; /* Tama√±o √≥ptimo para Pacifico */
            color: #5d4037;
            opacity: 0;
            transition: opacity 0.5s ease;
            text-align: center;
            pointer-events: none;
            padding: 8px 10px;
            z-index: 10;
            position: relative;
            line-height: 1.4; /* Espaciado entre l√≠neas */
            text-shadow: 0.5px 0.5px 1px rgba(0,0,0,0.1); /* Sombra sutil */
            letter-spacing: 0.2px; /* Espaciado entre letras */
            font-weight: normal; /* Pacifico no tiene pesos diferentes */
        }

        /* --- EMOJIS POSICIONADOS EN EL SOBRE (NO EN LA CARTA) --- */
        .emoji-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .emoji-top, .emoji-bottom {
            position: absolute;
            font-size: 24px;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.3s ease;
            z-index: 15;
            pointer-events: none;
            left: 50%;
            transform: translateX(-50%);
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
        }

        .emoji-top {
            top: -35px;
        }

        .emoji-bottom {
            bottom: -35px;
        }

        /* Mostrar texto y emojis simult√°neamente */
        .envelope.show-text .letter-content,
        .envelope.show-text .emoji-top,
        .envelope.show-text .emoji-bottom {
            opacity: 1;
        }
        
        .envelope.show-text .emoji-top {
            animation: floatUp 2s ease-in-out infinite;
        }
        
        .envelope.show-text .emoji-bottom {
            animation: floatDown 2s ease-in-out infinite;
        }
        
        /* ANIMACIONES DE LA CARTA */
        .envelope.open .letter {
            animation-name: remove;
        }
        
        .envelope.closing-step3 .letter {
            animation-name: return;
            animation-delay: 0s;
            animation-duration: 1.5s;
            z-index: 1;
        }
        
        .envelope.letter-open .letter {
            top: 8px;
            z-index: 4 !important;
            animation: none !important;
        }
        
        .envelope.closing-step1 .letter,
        .envelope.closing-step2 .letter {
            z-index: 4 !important;
        }
        
        /* PLIEGUES DE LA CARTA */
        .envelope .letter:before,
        .envelope .letter:after {
            content: '';
            position: absolute;
            width: 192px;
            height: 75%;
            left: -1px;
            background: linear-gradient(to bottom, #fff9f9, #fff);
            border: 1px solid rgba(255, 107, 107, 0.3);
            animation-duration: 1s;
            animation-fill-mode: forwards;
            transform-origin: top;
            transform-style: preserve-3d;
        }
        
        .envelope .letter:before {
            z-index: 2;
            transform: rotateX(10deg);
        }
        
        .envelope.open .letter:before {
            animation-name: fold-up;
            animation-delay: 3.5s;
        }
        
        .envelope.closing-step2 .letter:before {
            animation-name: fold-up-reverse;
            animation-delay: 0s;
        }
        
        .envelope.letter-open .letter:before {
            transform: rotateX(140deg);
            animation: none !important;
        }
        
        .envelope.closing-step1 .letter:before {
            transform: rotateX(140deg) !important;
            animation: none !important;
        }
        
        .envelope .letter:after {
            z-index: 2;
            transform-origin: bottom;
            transform: rotateX(-5deg);
            bottom: 0;
        }
        
        .envelope.open .letter:after {
            animation-name: fold-down;
            animation-delay: 4.5s;
        }
        
        .envelope.closing-step1 .letter:after {
            animation-name: fold-down-reverse;
            animation-delay: 0s;
        }
        
        .envelope.letter-open .letter:after {
            transform: rotateX(-140deg);
            animation: none !important;
        }
        
        /* --- KEYFRAMES --- */
        @keyframes flip { 
            100% { transform: rotateX(180deg); z-index: 1; } 
        }
        
        @keyframes flip-reverse { 
            0% { transform: rotateX(180deg); z-index: 1; } 
            100% { transform: rotateX(0deg); z-index: 3; } 
        }
        
        @keyframes remove { 
            0% { top: 8px; z-index: 1; } 
            50% { top: -120px; z-index: 4; } 
            100% { top: 8px; z-index: 4; } 
        }
        
        @keyframes return { 
            0% { top: 8px; z-index: 4; } 
            40% { top: -120px; z-index: 4; } 
            41% { top: -120px; z-index: 1; } 
            100% { top: 8px; z-index: 1; } 
        }
        
        @keyframes fold-up { 
            0% { transform: rotateX(10deg); } 
            100% { transform: rotateX(140deg); } 
        }
        
        @keyframes fold-up-reverse { 
            0% { transform: rotateX(140deg); } 
            100% { transform: rotateX(10deg); } 
        }
        
        @keyframes fold-down { 
            0% { transform: rotateX(-5deg); } 
            100% { transform: rotateX(-140deg); } 
        }
        
        @keyframes fold-down-reverse { 
            0% { transform: rotateX(-140deg); } 
            100% { transform: rotateX(-5deg); } 
        }
        
        @keyframes floatUp {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        
        @keyframes floatDown {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(5px); }
        }

        /* Animaciones espec√≠ficas para m√≥vil */
        @keyframes floatUpMobile {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-3px); }
        }

        @keyframes floatDownMobile {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(3px); }
        }
        
        /* Media queries para m√≥vil */
        @media (max-width: 768px) {
            body {
                padding: 15px;
                background: #1a237e;
            }
            
            .envelope {
                transform: scale(1.3);
                margin: 0 auto;
            }
            
            .envelope:hover {
                transform: scale(1.3) translateY(-2px);
            }
            
            .envelope:active {
                transform: scale(1.3) translateY(0);
            }
            
            .letter-content {
                font-size: 16px; /* Un poco m√°s grande en m√≥vil */
                padding: 6px 8px;
            }
            
            /* CORRECCI√ìN PARA LOS EMOJIS EN M√ìVIL */
            .emoji-top, .emoji-bottom {
                font-size: 18px;
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
            }
            
            /* Ajustar posici√≥n del emoji superior para que no se salga */
            .emoji-top {
                top: -28px; /* Reducido de -35px a -28px */
            }
            
            .emoji-bottom {
                bottom: -28px; /* Reducido de -35px a -28px */
            }
            
            /* Ajustar las animaciones para la nueva posici√≥n */
            .envelope.show-text .emoji-top {
                animation: floatUpMobile 2s ease-in-out infinite;
            }
            
            .envelope.show-text .emoji-bottom {
                animation: floatDownMobile 2s ease-in-out infinite;
            }
            
            /* Ajustes para el bot√≥n de m√∫sica en m√≥vil */
            .music-control {
                bottom: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
            }
            
            .music-control i {
                font-size: 20px;
            }
            
            .music-notification {
                bottom: 70px;
                right: 15px;
                font-size: 12px;
                max-width: 180px;
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .envelope {
                transform: scale(1.2);
            }
            
            .envelope:hover {
                transform: scale(1.2) translateY(-2px);
            }
            
            .envelope:active {
                transform: scale(1.2) translateY(0);
            }
            
            .letter-content {
                font-size: 15px; /* Tama√±o √≥ptimo para pantallas muy peque√±as */
            }
            
            /* Ajustar a√∫n m√°s para pantallas muy peque√±as */
            .emoji-top, .emoji-bottom {
                font-size: 16px;
            }
            
            .emoji-top {
                top: -25px;
            }
            
            .emoji-bottom {
                bottom: -25px;
            }
            
            /* Ajustes para pantallas muy peque√±as */
            .music-control {
                bottom: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
            
            .music-control i {
                font-size: 18px;
            }
            
            .music-notification {
                bottom: 60px;
                right: 10px;
                font-size: 11px;
                max-width: 160px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div class="envelope">
            <div class="flap front"></div>
            <div class="flap top"></div>
            <div class="letter">
                <div class="letter-content" id="texto-carta"></div>
            </div>
            <!-- Contenedor para los emojis, fuera de la carta pero dentro del sobre -->
            <div class="emoji-container">
                <div class="emoji-top" id="emoji-top"></div>
                <div class="emoji-bottom" id="emoji-bottom"></div>
            </div>
        </div>
    </div>
    
    <!-- Bot√≥n de control de m√∫sica -->
    <div class="music-control" id="musicControl">
        <i class="fas fa-music"></i>
    </div>
    
    <!-- Notificaci√≥n de m√∫sica -->
    <div class="music-notification" id="musicNotification">
        M√∫sica activada. ¬°Disfruta de la experiencia!
    </div>
    
    <!-- Audio para la m√∫sica de fondo con TU CANCI√ìN -->
    <audio id="backgroundMusic" loop preload="auto">
        <source src="https://ionut5251.github.io/Notitas/cancion.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <script>
        $(document).ready(function() {
            let sobreAbierto = false;
            let animando = false;
            let animacionAbiertaCompleta = false;
            
            // --- L√ìGICA DE TEXTOS ALEATORIOS CON EMOJIS ASIGNADOS ---
            const textosConEmojis = [
                {
                    texto: "Keep shining!",
                    emoji: "‚ú®" 
                },
                {
                    texto: "Hoy te ves incre√≠ble!", 
                    emoji: "üòç" 
                },
                {
                    texto: "Sonrie!",
                    emoji: "üòä" 
                },
                {
                    texto: "Tienes una sonrisa especial!",
                    emoji: "ü•∞" 
                },
                {
                    texto: "Beautiful smile!",
                    emoji: "ü§ó" 
                },
                {
                    texto: "Eres mi pensamiento favorito.",
                    emoji: "üí≠"  
                },
                {
                    texto: "Haces que todo sea m√°s bonito.",
                    emoji: "üåà"  
                },
                {
                    texto: "Mi lugar favorito eres t√∫!",
                    emoji: "‚≠êÔ∏è"  
                },
                {
                    texto: "¬°T√∫ puedes con todo hoy!",
                    emoji: "üí™üèº"  
                },
                {
                    texto: "Que nada te quite esa sonrisa!",
                    emoji: "üíô"  
                },
                {
                    texto: "Cualquier d√≠a se vuelve m√°s bonito cuando te veo sonre√≠r.",
                    emoji: "üå∏" 
                },
                {
                    texto: "Tu sonrisa es mi luz.",
                    emoji: "üåü" 
                },
                {
                    texto: "Tu esencia alegra todo.",
                    emoji: "üå∑" 
                },
                {
                    texto: "Me encantas exactamente como eres!",
                    emoji: "üíñ" 
                },
                {
                    texto: "You are my favorite smile!",
                    emoji: "üòò" 
                },
                {
                    texto: "Es imposible no sonre√≠r contigo.",
                    emoji: "üòå"  
                },
                {
                    texto: "Eres m√°s incre√≠ble de lo que crees!",
                    emoji: "üöÄ" 
                }
            ];
            
            // Copia de la lista para ir quitando los que ya salieron
            let textosDisponibles = [...textosConEmojis];

            function obtenerTextoYEmojiAleatorio() {
                // Si nos quedamos sin textos, reiniciamos la lista
                if (textosDisponibles.length === 0) {
                    textosDisponibles = [...textosConEmojis];
                }
                
                // Elegimos un √≠ndice al azar de los disponibles
                const indice = Math.floor(Math.random() * textosDisponibles.length);
                // Extraemos el texto y emoji de la lista (sac√°ndolo con splice)
                const textoElegido = textosDisponibles.splice(indice, 1)[0];
                
                return textoElegido;
            }
            
            function abrirSobre() {
                if (animando) return;
                animando = true;
                animacionAbiertaCompleta = false;
                
                // Obtenemos texto y emoji aleatorio
                const contenido = obtenerTextoYEmojiAleatorio();
                
                // Inyectamos el nuevo texto antes de empezar la animaci√≥n
                $('#texto-carta').text(contenido.texto);
                
                // Asignamos el emoji correspondiente tanto arriba como abajo
                $('#emoji-top').text(contenido.emoji);
                $('#emoji-bottom').text(contenido.emoji);
                
                // Registrar la visita con el mensaje que se mostr√≥
                registrarVisita(contenido.texto, contenido.emoji);
                
                $('.envelope').removeClass('letter-open closing-step1 closing-step2 closing-step3 closing-step4 show-text');
                $('.envelope').addClass('open');
                sobreAbierto = true;
                
                setTimeout(function() {
                    $('.envelope').removeClass('open').addClass('letter-open');
                    
                    setTimeout(function() {
                        // Al a√±adir show-text, tanto el texto como los emojis aparecer√°n (CSS opacity)
                        $('.envelope').addClass('show-text');
                        animacionAbiertaCompleta = true;
                        animando = false;
                    }, 500);
                }, 6000);
            }
            
            function iniciarCierre() {
                if (animando || !sobreAbierto) return;
                animando = true;
                
                // Al quitar show-text, el texto y los emojis desaparecen inmediatamente con la transici√≥n
                $('.envelope').removeClass('show-text');
                
                setTimeout(function() {
                    if (!animacionAbiertaCompleta) {
                        $('.envelope').removeClass('open').addClass('letter-open');
                    }
                    
                    $('.envelope').removeClass('letter-open').addClass('closing-step1');
                    
                    setTimeout(function() {
                        $('.envelope').removeClass('closing-step1').addClass('closing-step2');
                        
                        setTimeout(function() {
                            $('.envelope').removeClass('closing-step2').addClass('closing-step3');
                            
                            setTimeout(function() {
                                $('.envelope').removeClass('closing-step3').addClass('closing-step4');
                                sobreAbierto = false;
                                animacionAbiertaCompleta = false;
                                
                                setTimeout(function() {
                                    $('.envelope').removeClass('closing-step4');
                                    // Limpiamos el texto y emojis al terminar de cerrar para el siguiente ciclo
                                    $('#texto-carta').text('');
                                    $('#emoji-top').text('');
                                    $('#emoji-bottom').text('');
                                    animando = false;
                                }, 1000);
                            }, 1500);
                        }, 1000);
                    }, 1000);
                }, 500);
            }
            
            $('.envelope').click(function() {
                if (sobreAbierto) iniciarCierre();
                else abrirSobre();
            });
            
            $('.envelope').on('touchstart', function(e) {
                e.preventDefault();
                if (sobreAbierto) iniciarCierre();
                else abrirSobre();
            });
            
            // --- L√ìGICA DE M√öSICA DE FONDO ---
            const musicPlayer = document.getElementById('backgroundMusic');
            const musicControl = document.getElementById('musicControl');
            const musicNotification = document.getElementById('musicNotification');
            
            let musicEnabled = false;
            let userInteracted = false;
            let wasPlayingBeforeHidden = false;
            
            // Mostrar notificaci√≥n
            function showNotification(message) {
                musicNotification.textContent = message;
                musicNotification.classList.add('show');
                
                setTimeout(function() {
                    musicNotification.classList.remove('show');
                }, 3000);
            }
            
            // Intentar reproducir m√∫sica (requiere interacci√≥n del usuario)
            function playMusic() {
                if (!userInteracted) {
                    showNotification("Toca el bot√≥n de m√∫sica para activarla");
                    return;
                }
                
                musicPlayer.volume = 0.5; // Volumen al 50%
                musicPlayer.play().then(() => {
                    musicEnabled = true;
                    musicControl.classList.add('playing');
                    musicControl.classList.add('pulsing');
                    showNotification("M√∫sica activada. ¬°Disfruta de la experiencia!");
                }).catch(error => {
                    console.log("Error al reproducir m√∫sica:", error);
                    showNotification("No se pudo reproducir la m√∫sica. Intenta nuevamente.");
                });
            }
            
            // Pausar m√∫sica
            function pauseMusic() {
                musicPlayer.pause();
                musicEnabled = false;
                musicControl.classList.remove('playing');
                musicControl.classList.remove('pulsing');
            }
            
            // Controlador de clic en el bot√≥n de m√∫sica
            musicControl.addEventListener('click', function() {
                userInteracted = true;
                
                if (musicEnabled) {
                    pauseMusic();
                    showNotification("M√∫sica pausada");
                } else {
                    playMusic();
                }
            });
            
            // Control t√°ctil para m√≥viles
            musicControl.addEventListener('touchstart', function(e) {
                e.preventDefault();
                userInteracted = true;
                
                if (musicEnabled) {
                    pauseMusic();
                    showNotification("M√∫sica pausada");
                } else {
                    playMusic();
                }
            });
            
            // --- DETECCI√ìN DE VISIBILIDAD DE LA P√ÅGINA ---
            // Pausar m√∫sica cuando la p√°gina no est√° visible (cambio de pesta√±a o minimizada)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // La p√°gina ya no es visible
                    if (musicEnabled && !musicPlayer.paused) {
                        wasPlayingBeforeHidden = true;
                        pauseMusic();
                    }
                } else {
                    // La p√°gina es visible nuevamente
                    if (wasPlayingBeforeHidden && userInteracted) {
                        wasPlayingBeforeHidden = false;
                        playMusic();
                    }
                }
            });
            
            // Tambi√©n detectar cuando la ventana pierde el foco
            window.addEventListener('blur', function() {
                if (musicEnabled && !musicPlayer.paused) {
                    wasPlayingBeforeHidden = true;
                    pauseMusic();
                }
            });
            
            // Restaurar cuando la ventana recupera el foco
            window.addEventListener('focus', function() {
                if (wasPlayingBeforeHidden && userInteracted) {
                    wasPlayingBeforeHidden = false;
                    playMusic();
                }
            });
            
            // Mostrar notificaci√≥n de bienvenida despu√©s de cargar
            setTimeout(function() {
                showNotification("¬øQuieres m√∫sica de fondo? Toca el bot√≥n rojo abajo");
                
                // Hacer que el bot√≥n parpadee para llamar la atenci√≥n
                setTimeout(function() {
                    musicControl.classList.add('pulsing');
                    
                    // Quitar el parpadeo despu√©s de 10 segundos
                    setTimeout(function() {
                        if (!musicEnabled) {
                            musicControl.classList.remove('pulsing');
                        }
                    }, 10000);
                }, 1000);
            }, 2000);
            
            // Intentar reproducci√≥n autom√°tica despu√©s de la primera interacci√≥n con el sobre
            $('.envelope').on('click touchstart', function() {
                if (!userInteracted) {
                    userInteracted = true;
                    // Despu√©s de abrir el sobre, sugerir m√∫sica
                    setTimeout(function() {
                        if (!musicEnabled) {
                            showNotification("¬øTe gustar√≠a a√±adir m√∫sica de fondo?");
                            musicControl.classList.add('pulsing');
                            
                            setTimeout(function() {
                                if (!musicEnabled) {
                                    musicControl.classList.remove('pulsing');
                                }
                            }, 5000);
                        }
                    }, 8000); // 8 segundos despu√©s de abrir
                }
            });
            
            // ==============================================
            // SISTEMA DE REGISTRO DE VISITAS MEJORADO
            // ==============================================
            
            // Funci√≥n para registrar visita
            function registrarVisita(mensaje, emoji) {
                try {
                    // Crear objeto de visita
                    const visita = {
                        fecha: new Date().toLocaleDateString('es-ES'),
                        hora: new Date().toLocaleTimeString('es-ES'),
                        timestamp: Date.now(),
                        mensaje: mensaje,
                        emoji: emoji,
                        dispositivo: /Mobi|Android/i.test(navigator.userAgent) ? 'm√≥vil' : 'desktop',
                        navegador: navigator.userAgent.substring(0, 100) // Solo primeros 100 caracteres
                    };
                    
                    console.log('üìù Visita registrada:', visita);
                    
                    // Guardar en localStorage
                    guardarVisitaLocal(visita);
                    
                    // Mostrar resumen autom√°ticamente en consola
                    mostrarResumenVisitas();
                    
                } catch (error) {
                    console.error('Error al registrar visita:', error);
                }
            }
            
            // Funci√≥n para guardar visita localmente
            function guardarVisitaLocal(visita) {
                try {
                    // Obtener historial existente
                    let historial = JSON.parse(localStorage.getItem('historial_visitas') || '[]');
                    
                    // A√±adir nueva visita
                    historial.push(visita);
                    
                    // Mantener solo las √∫ltimas 100 visitas
                    if (historial.length > 100) {
                        historial = historial.slice(-100);
                    }
                    
                    // Guardar en localStorage
                    localStorage.setItem('historial_visitas', JSON.stringify(historial));
                    localStorage.setItem('ultima_visita', JSON.stringify(visita));
                    
                } catch (error) {
                    console.error('Error al guardar visita local:', error);
                }
            }
            
            // Funci√≥n para mostrar resumen COMPLETO de visitas
            function mostrarResumenVisitas() {
                try {
                    const historial = JSON.parse(localStorage.getItem('historial_visitas') || '[]');
                    
                    if (historial.length === 0) {
                        console.log('üìä No hay visitas registradas a√∫n.');
                        return;
                    }
                    
                    console.clear();
                    console.log('%cüìä ===== RESUMEN COMPLETO DE VISITAS =====', 'color: #ff5252; font-size: 16px; font-weight: bold');
                    console.log(`%cTOTAL VISITAS: ${historial.length}`, 'color: #4CAF50; font-size: 14px;');
                    
                    // Mostrar visitas de HOY
                    const hoy = new Date().toLocaleDateString('es-ES');
                    const visitasHoy = historial.filter(v => v.fecha === hoy);
                    console.log(`%cüìÖ Hoy (${hoy}): ${visitasHoy.length} visita(s)`, 'color: #2196F3;');
                    
                    // Mostrar TODAS las visitas en orden cronol√≥gico inverso (m√°s recientes primero)
                    console.log('\n%cüìã TODAS LAS VISITAS (m√°s recientes primero):', 'color: #9C27B0; font-weight: bold');
                    
                    historial.slice().reverse().forEach((visita, index) => {
                        const num = historial.length - index;
                        console.log(`\n%c${num}. ${visita.fecha} - ${visita.hora}`, 'color: #FF9800;');
                        console.log(`   üíå "${visita.mensaje}" ${visita.emoji}`);
                        console.log(`   üì± ${visita.dispositivo}`);
                        console.log(`   üåê ${visita.navegador.split(' ')[0]}`); // Solo el nombre del navegador
                    });
                    
                    // Resumen por d√≠a
                    console.log('\n%cüìà RESUMEN POR D√çA:', 'color: #E91E63; font-weight: bold');
                    const resumenDias = {};
                    historial.forEach(visita => {
                        if (resumenDias[visita.fecha]) {
                            resumenDias[visita.fecha]++;
                        } else {
                            resumenDias[visita.fecha] = 1;
                        }
                    });
                    
                    // Ordenar d√≠as (m√°s reciente primero)
                    Object.keys(resumenDias)
                        .sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')))
                        .forEach(fecha => {
                            const barras = '‚ñà'.repeat(Math.min(resumenDias[fecha], 20));
                            console.log(`   ${fecha}: ${barras} ${resumenDias[fecha]}`);
                        });
                    
                    console.log('\n%c============================================', 'color: #ff5252; font-weight: bold');
                    
                } catch (error) {
                    console.error('Error al mostrar resumen:', error);
                }
            }
            
            // Funci√≥n para mostrar estad√≠sticas r√°pidas (sin alert, solo consola)
            function mostrarEstadisticasRapidas() {
                const historial = JSON.parse(localStorage.getItem('historial_visitas') || '[]');
                const hoy = new Date().toLocaleDateString('es-ES');
                const visitasHoy = historial.filter(v => v.fecha === hoy);
                
                console.log(`üìä Hoy has usado la app ${visitasHoy.length} vez/veces`);
                console.log(`üìà Total de visitas registradas: ${historial.length}`);
                
                if (visitasHoy.length > 0) {
                    console.log('\nüìÖ Tus visitas de hoy:');
                    visitasHoy.slice().reverse().forEach((visita, index) => {
                        console.log(`   ${index + 1}. ${visita.hora} - "${visita.mensaje}" ${visita.emoji}`);
                    });
                }
            }
            
            // Registrar cuando la p√°gina se carga por primera vez
            setTimeout(function() {
                if (!sessionStorage.getItem('visita_registrada')) {
                    registrarVisita('P√°gina cargada', 'üì±');
                    sessionStorage.setItem('visita_registrada', 'true');
                }
                
                // Mostrar instrucciones en consola
                console.log('%cüîç INSTRUCCIONES PARA VER ESTAD√çSTICAS:', 'color: #4CAF50; font-weight: bold');
                console.log('1. Abre la consola (F12 ‚Üí Console)');
                console.log('2. Cada vez que abras un mensaje, se mostrar√° autom√°ticamente el resumen');
                console.log('3. O escribe en la consola: mostrarResumenVisitas()');
                console.log('4. Para un resumen r√°pido: mostrarEstadisticasRapidas()');
                console.log('\nüìù Las visitas se guardan en localStorage de tu navegador.');
                
            }, 1000);
            
            // Hacer las funciones accesibles desde la consola
            window.mostrarResumenVisitas = mostrarResumenVisitas;
            window.mostrarEstadisticasRapidas = mostrarEstadisticasRapidas;
        });
    </script>
</body>
</html>